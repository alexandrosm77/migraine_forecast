name: Docker Image CI

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: self-hosted
    environment: latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      -
        name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      -
        name: Get current version
        id: get_version
        run: |
          VERSION=$(python3 -c "import sys; sys.path.insert(0, '.'); from forecast.__version__ import __version__; print(__version__)")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      -
        name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      -
        name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      -
        name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          push: true
          platforms: linux/arm64
#           platforms: linux/amd64,linux/arm64
          tags: |
            alexandrosm77/migraine_forecast:latest
            alexandrosm77/migraine_forecast:${{ steps.get_version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  test-linting:
    needs: build
    runs-on: self-hosted
    steps:
      -
        name: Checkout repository
        uses: actions/checkout@v4

      -
        name: Run linting checks
        run: |
          docker run --rm \
            alexandrosm77/migraine_forecast@${{ needs.build.outputs.image-digest }} \
            sh -c "pip install flake8 && flake8 forecast/ migraine_project/ --exclude=migrations,__pycache__ --max-line-length=120 --statistics"

  test-unittest:
    needs: build
    runs-on: self-hosted
    steps:
      -
        name: Checkout repository
        uses: actions/checkout@v4

      -
        name: Run unit tests in Docker container
        run: |
          docker run --rm \
            alexandrosm77/migraine_forecast@${{ needs.build.outputs.image-digest }} \
            python manage.py test forecast.tests --verbosity=2

  test-integration:
    needs: build
    runs-on: self-hosted
    steps:
      -
        name: Checkout repository
        uses: actions/checkout@v4

      -
        name: Run integration tests in Docker container
        run: |
          docker run --rm \
            alexandrosm77/migraine_forecast@${{ needs.build.outputs.image-digest }} \
            python manage.py test forecast.integration_tests --verbosity=2

  deploy:
    needs: [test-linting, test-unittest, test-integration]
    runs-on: self-hosted
    environment: latest
    # Ensure only one deployment runs at a time
    concurrency:
      group: deployment
      cancel-in-progress: false
    steps:
      -
        name: Stop current application and backup database
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "$(date '+%Y-%m-%d %H:%M:%S') - Starting deployment of alexandrosm77/migraine_forecast:latest..."

            # Stop existing container if it exists
            if docker ps -a --format '{{.Names}}' | grep -q "^migraine$"; then
              echo "$(date '+%Y-%m-%d %H:%M:%S') - Stopping existing container..."
              docker stop migraine
            fi

            # Backup database
            echo "$(date '+%Y-%m-%d %H:%M:%S') - Backing up database..."
            BACKUP_DIR="/home/alexandros/migraine/backups"
            mkdir -p "$BACKUP_DIR"
            BACKUP_FILE="$BACKUP_DIR/db.sqlite3.backup.$(date '+%Y%m%d_%H%M%S')"

            if [ -f /home/alexandros/migraine/db.sqlite3 ]; then
              cp /home/alexandros/migraine/db.sqlite3 "$BACKUP_FILE"
              echo "$(date '+%Y-%m-%d %H:%M:%S') - Database backed up to: $BACKUP_FILE"

              # Keep only the last 10 backups
              ls -t "$BACKUP_DIR"/db.sqlite3.backup.* 2>/dev/null | tail -n +11 | xargs -r rm
              echo "$(date '+%Y-%m-%d %H:%M:%S') - Old backups cleaned up (keeping last 10)"
            else
              echo "$(date '+%Y-%m-%d %H:%M:%S') - No existing database found, skipping backup"
            fi

      -
        name: Pull latest image and run migrations
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Docker Hub login
            echo "$(date '+%Y-%m-%d %H:%M:%S') - Authenticating with Docker Hub..."
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ vars.DOCKERHUB_USERNAME }}" --password-stdin

            # Pull the latest image
            echo "$(date '+%Y-%m-%d %H:%M:%S') - Pulling the latest image..."
            docker pull alexandrosm77/migraine_forecast:latest

            # Run migrations in a temporary container
            echo "$(date '+%Y-%m-%d %H:%M:%S') - Running database migrations..."
            docker run --rm \
              -v /home/alexandros/migraine/db.sqlite3:/app/db.sqlite3 \
              alexandrosm77/migraine_forecast:latest \
              python manage.py migrate --noinput

            if [ $? -eq 0 ]; then
              echo "$(date '+%Y-%m-%d %H:%M:%S') - Migrations completed successfully"
            else
              echo "$(date '+%Y-%m-%d %H:%M:%S') - Error: Migrations failed!"
              echo "$(date '+%Y-%m-%d %H:%M:%S') - Database backup is available in /home/alexandros/migraine/backups/ for manual recovery if needed"
              exit 1
            fi

      -
        name: Deploy application
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Remove old container if it exists
            if docker ps -a --format '{{.Names}}' | grep -q "^migraine$"; then
              echo "$(date '+%Y-%m-%d %H:%M:%S') - Removing old container..."
              docker rm migraine
            fi

            # Create and start the new container
            echo "$(date '+%Y-%m-%d %H:%M:%S') - Creating and starting new container..."
            docker run -d \
              --name migraine \
              --restart unless-stopped \
              -p 8889:8889 \
              -v /home/alexandros/migraine/db.sqlite3:/app/db.sqlite3 \
              -e DJANGO_DEBUG=False \
              -e "SENTRY_DSN=${{ secrets.SENTRY_DSN }}" \
              -e "SENTRY_ENABLED=${{ vars.SENTRY_ENABLED }}" \
              -e "SENTRY_ENVIRONMENT=${{ vars.SENTRY_ENVIRONMENT }}" \
              -e "SENTRY_TRACES_SAMPLE_RATE=${{ vars.SENTRY_TRACES_SAMPLE_RATE }}" \
              -e "SENTRY_PROFILES_SAMPLE_RATE=${{ vars.SENTRY_PROFILES_SAMPLE_RATE }}" \
              alexandrosm77/migraine_forecast:latest

            # Check if the container started successfully
            if docker ps --format '{{.Names}}' | grep -q "^migraine$"; then
              echo "$(date '+%Y-%m-%d %H:%M:%S') - Deployment successful! Container is running."
              echo "$(date '+%Y-%m-%d %H:%M:%S') - Container logs (last 10 lines):"
              docker logs migraine --tail 10
            else
              echo "$(date '+%Y-%m-%d %H:%M:%S') - Error: Container failed to start."
              echo "$(date '+%Y-%m-%d %H:%M:%S') - Check logs with: docker logs migraine"
              echo "$(date '+%Y-%m-%d %H:%M:%S') - Database backup is available in /home/alexandros/migraine/backups/ for manual recovery if needed"
              exit 1
            fi

  cleanup:
    needs: deploy
    runs-on: self-hosted
    environment: latest
    if: always()
    steps:
      -
        name: Clean up dangling Docker images on deployment host
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "Cleaning up dangling Docker images..."
            docker image prune -f
            echo "Cleanup complete. Current images:"
            docker images alexandrosm77/migraine_forecast
