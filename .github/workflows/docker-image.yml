name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      bump_version:
        description: 'Bump version before build and deployment'
        required: true
        default: 'none'
        type: choice
        options:
          - none
          - patch
          - minor
          - major

jobs:
  build:
    runs-on: self-hosted
    environment: latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      -
        name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      -
        name: Install bump-my-version
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.bump_version != 'none'
        run: |
          pip3 install --user bump-my-version
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      -
        name: Configure Git
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.bump_version != 'none'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      -
        name: Bump version
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.bump_version != 'none'
        run: |
          echo "Bumping ${{ github.event.inputs.bump_version }} version..."
          python3 -m bump_my_version bump ${{ github.event.inputs.bump_version }} --allow-dirty
          git push --follow-tags

      -
        name: Get current version
        id: get_version
        run: |
          VERSION=$(python3 -c "import sys; sys.path.insert(0, '.'); from forecast.__version__ import __version__; print(__version__)")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      -
        name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      -
        name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      -
        name: Build and push
        uses: docker/build-push-action@v6
        with:
          push: true
          platforms: linux/arm64
#           platforms: linux/amd64,linux/arm64
          tags: |
            alexandrosm77/migraine_forecast:latest
            alexandrosm77/migraine_forecast:${{ steps.get_version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build
    runs-on: self-hosted
    environment: latest
    steps:
      -
        name: Checkout repository
        uses: actions/checkout@v4

      -
        name: Install SSH client if needed
        run: |
          which scp || apt-get update && apt-get install -y openssh-client

      -
        name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      -
        name: Copy file via direct SCP
        run: |
          scp -i ~/.ssh/id_rsa deploy.sh ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:/home/alexandros/migraine/

      -
        name: SSH into docker host and run deployment script
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            chmod +x /home/alexandros/migraine/deploy.sh
            /home/alexandros/migraine/deploy.sh \
              --dockerhub_username ${{ vars.DOCKERHUB_USERNAME }} \
              --dockerhub_token ${{ secrets.DOCKERHUB_TOKEN }} \
              --sentry_dsn "${{ secrets.SENTRY_DSN }}" \
              --sentry_enabled "${{ vars.SENTRY_ENABLED }}" \
              --sentry_environment "${{ vars.SENTRY_ENVIRONMENT }}" \
              --sentry_traces_sample_rate "${{ vars.SENTRY_TRACES_SAMPLE_RATE }}" \
              --sentry_profiles_sample_rate "${{ vars.SENTRY_PROFILES_SAMPLE_RATE }}"

  test-linting:
    needs: deploy
    runs-on: self-hosted
    continue-on-error: true
    steps:
      -
        name: Checkout repository
        uses: actions/checkout@v4

      -
        name: Run linting checks
        run: |
          docker run --rm \
            alexandrosm77/migraine_forecast:latest \
            sh -c "pip install flake8 && flake8 forecast/ migraine_project/ --exclude=migrations,__pycache__ --max-line-length=120 --statistics"

  test-unittest:
    needs: deploy
    runs-on: self-hosted
    continue-on-error: true
    steps:
      -
        name: Checkout repository
        uses: actions/checkout@v4

      -
        name: Run unit tests in Docker container
        run: |
          docker run --rm \
            alexandrosm77/migraine_forecast:latest \
            python manage.py test forecast.tests --verbosity=2

  test-integration:
    needs: deploy
    runs-on: self-hosted
    continue-on-error: true
    steps:
      -
        name: Checkout repository
        uses: actions/checkout@v4

      -
        name: Run integration tests in Docker container
        run: |
          docker run --rm \
            alexandrosm77/migraine_forecast:latest \
            python manage.py test forecast.integration_tests --verbosity=2
