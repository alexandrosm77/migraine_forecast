# Web Deployment - Runs Gunicorn web server (can scale)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: migraine-forecast-web
  namespace: migraine-forecast
  labels:
    app: migraine-forecast
    component: web
spec:
  # MUST be 1 for SQLite - only one pod can write to SQLite at a time
  replicas: 1

  # Deployment strategy - Recreate to avoid SQLite write conflicts
  strategy:
    type: Recreate  # Stop old pod before starting new one (important for SQLite!)

  selector:
    matchLabels:
      app: migraine-forecast
      component: web

  template:
    metadata:
      labels:
        app: migraine-forecast
        component: web
    spec:
      containers:
      - name: web
        image: alexandrosm77/migraine_forecast:latest
        imagePullPolicy: Always

        # Override CMD to run only gunicorn (no cron)
        command: ["/bin/bash", "-c"]
        args:
          - |
            echo "Starting gunicorn web server..."
            exec gunicorn migraine_project.wsgi:application -c gunicorn.conf.py

        ports:
        - containerPort: 8889
          name: http
          protocol: TCP

        # Environment variables from ConfigMap
        envFrom:
        - configMapRef:
            name: migraine-config

        # Environment variables from Secret
        env:
        - name: SENTRY_DSN
          valueFrom:
            secretKeyRef:
              name: migraine-secrets
              key: SENTRY_DSN

        # Volume mounts - read-write (web needs to write too)
        volumeMounts:
        - name: db-storage
          mountPath: /app/db.sqlite3
          subPath: db.sqlite3
          # No readOnly - web needs to write to database

        # Health checks
        livenessProbe:
          httpGet:
            path: /
            port: 8889
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

        readinessProbe:
          httpGet:
            path: /
            port: 8889
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3

        # Resource limits
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "1Gi"
            cpu: "1000m"

      volumes:
      - name: db-storage
        persistentVolumeClaim:
          claimName: migraine-db-pvc

---
# Cron Deployment - Runs scheduled tasks (single replica, no scaling)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: migraine-forecast-cron
  namespace: migraine-forecast
  labels:
    app: migraine-forecast
    component: cron
spec:
  # MUST be 1 - cron jobs should not run in parallel
  replicas: 1

  # Deployment strategy - Recreate to ensure only one cron pod at a time
  strategy:
    type: Recreate

  selector:
    matchLabels:
      app: migraine-forecast
      component: cron

  template:
    metadata:
      labels:
        app: migraine-forecast
        component: cron
    spec:
      containers:
      - name: cron
        image: alexandrosm77/migraine_forecast:latest
        imagePullPolicy: Always

        # Override CMD to run only cron (no gunicorn)
        command: ["/bin/bash", "-c"]
        args:
          - |
            echo "Starting cron daemon..."

            # Export environment variables to cron environment
            # Cron doesn't inherit environment variables from the container
            # so we need to explicitly write them to the crontab
            echo "Exporting environment variables to cron..."
            printenv | grep -E '^(SENTRY_|DJANGO_|LLM_|LOG_)' | sed 's/^\(.*\)$/export \1/g' > /etc/environment_vars.sh
            chmod +x /etc/environment_vars.sh

            # Update crontab to source environment variables before each command
            crontab -l > /tmp/current_cron
            sed -i 's|cd /app &&|cd /app \&\& . /etc/environment_vars.sh \&\&|g' /tmp/current_cron
            crontab /tmp/current_cron
            rm /tmp/current_cron

            echo "Environment variables exported to cron"
            echo "Starting cron daemon..."
            cron
            echo "Cron started. Tailing logs..."
            tail -f /var/log/cron.log

        # Graceful shutdown - wait for running cron jobs to finish
        lifecycle:
          preStop:
            exec:
              command:
                - /bin/bash
                - -c
                - |
                  echo "Received shutdown signal, waiting for cron jobs to finish..."
                  # Wait up to 60 seconds for any running Python processes to finish
                  for i in {1..60}; do
                    if ! pgrep -f "python manage.py" > /dev/null; then
                      echo "No cron jobs running, safe to shutdown"
                      exit 0
                    fi
                    echo "Waiting for cron jobs to finish... ($i/60)"
                    sleep 1
                  done
                  echo "Timeout reached, forcing shutdown"

        # Environment variables from ConfigMap
        envFrom:
        - configMapRef:
            name: migraine-config

        # Environment variables from Secret
        env:
        - name: SENTRY_DSN
          valueFrom:
            secretKeyRef:
              name: migraine-secrets
              key: SENTRY_DSN

        # Volume mounts - read-write for cron (writes to database)
        volumeMounts:
        - name: db-storage
          mountPath: /app/db.sqlite3
          subPath: db.sqlite3
          # No readOnly - cron needs to write

        # Resource limits - higher for LLM inference
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "1Gi"
            cpu: "1000m"

      volumes:
      - name: db-storage
        persistentVolumeClaim:
          claimName: migraine-db-pvc

