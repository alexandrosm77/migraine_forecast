# Web Deployment - Runs Gunicorn web server (can scale)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: migraine-forecast-web
  namespace: migraine-forecast
  labels:
    app: migraine-forecast
    component: web
spec:
  # MUST be 1 for SQLite - only one pod can write to SQLite at a time
  replicas: 1

  # Deployment strategy - Recreate to avoid SQLite write conflicts
  strategy:
    type: Recreate  # Stop old pod before starting new one (important for SQLite!)

  selector:
    matchLabels:
      app: migraine-forecast
      component: web

  template:
    metadata:
      labels:
        app: migraine-forecast
        component: web
    spec:
      containers:
      - name: web
        image: alexandrosm77/migraine_forecast:latest
        imagePullPolicy: Always

        # Override CMD to run only gunicorn (no cron)
        command: ["/bin/bash", "-c"]
        args:
          - |
            echo "Starting gunicorn web server..."
            exec gunicorn migraine_project.wsgi:application -c gunicorn.conf.py

        ports:
        - containerPort: 8889
          name: http
          protocol: TCP

        # Environment variables from ConfigMap
        envFrom:
        - configMapRef:
            name: migraine-config

        # Environment variables from Secret
        env:
        - name: SENTRY_DSN
          valueFrom:
            secretKeyRef:
              name: migraine-secrets
              key: SENTRY_DSN
        - name: CELERY_BROKER_URL
          valueFrom:
            secretKeyRef:
              name: migraine-secrets
              key: CELERY_BROKER_URL
        - name: CELERY_RESULT_BACKEND
          valueFrom:
            secretKeyRef:
              name: migraine-secrets
              key: CELERY_RESULT_BACKEND
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: migraine-secrets
              key: DB_PASSWORD

        # Volume mounts - read-write (web needs to write too)
        volumeMounts:
        - name: db-storage
          mountPath: /app/db.sqlite3
          subPath: db.sqlite3
          # No readOnly - web needs to write to database

        # Health checks
        livenessProbe:
          httpGet:
            path: /
            port: 8889
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

        readinessProbe:
          httpGet:
            path: /
            port: 8889
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3

        # Resource limits
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "1Gi"
            cpu: "1000m"

      volumes:
      - name: db-storage
        persistentVolumeClaim:
          claimName: migraine-db-pvc

---
# Celery Worker - Default Queue (orchestration, weather, email)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: migraine-forecast-worker-default
  namespace: migraine-forecast
  labels:
    app: migraine-forecast
    component: worker-default
spec:
  replicas: 1

  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  selector:
    matchLabels:
      app: migraine-forecast
      component: worker-default

  template:
    metadata:
      labels:
        app: migraine-forecast
        component: worker-default
    spec:
      containers:
      - name: worker-default
        image: alexandrosm77/migraine_forecast:latest
        imagePullPolicy: Always

        command: ["/bin/bash", "-c"]
        args:
          - |
            echo "Starting Celery worker for default queue..."
            exec celery -A migraine_project worker \
              --loglevel=info \
              --queues=default \
              --concurrency=2 \
              --max-tasks-per-child=100

        # Graceful shutdown
        lifecycle:
          preStop:
            exec:
              command:
                - /bin/bash
                - -c
                - |
                  echo "Received shutdown signal, waiting for tasks to finish..."
                  sleep 10

        envFrom:
        - configMapRef:
            name: migraine-config

        env:
        - name: SENTRY_DSN
          valueFrom:
            secretKeyRef:
              name: migraine-secrets
              key: SENTRY_DSN
        - name: CELERY_BROKER_URL
          valueFrom:
            secretKeyRef:
              name: migraine-secrets
              key: CELERY_BROKER_URL
        - name: CELERY_RESULT_BACKEND
          valueFrom:
            secretKeyRef:
              name: migraine-secrets
              key: CELERY_RESULT_BACKEND
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: migraine-secrets
              key: DB_PASSWORD

        volumeMounts:
        - name: db-storage
          mountPath: /app/db.sqlite3
          subPath: db.sqlite3

        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"

      volumes:
      - name: db-storage
        persistentVolumeClaim:
          claimName: migraine-db-pvc

---
# Celery Worker - LLM Queue (MUST run with concurrency=1)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: migraine-forecast-worker-llm
  namespace: migraine-forecast
  labels:
    app: migraine-forecast
    component: worker-llm
spec:
  # MUST be 1 - LLM API constraint
  replicas: 1

  # Recreate strategy to ensure only one LLM worker at a time
  strategy:
    type: Recreate

  selector:
    matchLabels:
      app: migraine-forecast
      component: worker-llm

  template:
    metadata:
      labels:
        app: migraine-forecast
        component: worker-llm
    spec:
      containers:
      - name: worker-llm
        image: alexandrosm77/migraine_forecast:latest
        imagePullPolicy: Always

        command: ["/bin/bash", "-c"]
        args:
          - |
            echo "Starting Celery worker for LLM queue (concurrency=1)..."
            exec celery -A migraine_project worker \
              --loglevel=info \
              --queues=llm \
              --concurrency=1 \
              --max-tasks-per-child=50

        # Graceful shutdown - important for LLM tasks
        lifecycle:
          preStop:
            exec:
              command:
                - /bin/bash
                - -c
                - |
                  echo "Received shutdown signal, waiting for LLM tasks to finish..."
                  sleep 30

        envFrom:
        - configMapRef:
            name: migraine-config

        env:
        - name: SENTRY_DSN
          valueFrom:
            secretKeyRef:
              name: migraine-secrets
              key: SENTRY_DSN
        - name: CELERY_BROKER_URL
          valueFrom:
            secretKeyRef:
              name: migraine-secrets
              key: CELERY_BROKER_URL
        - name: CELERY_RESULT_BACKEND
          valueFrom:
            secretKeyRef:
              name: migraine-secrets
              key: CELERY_RESULT_BACKEND
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: migraine-secrets
              key: DB_PASSWORD

        volumeMounts:
        - name: db-storage
          mountPath: /app/db.sqlite3
          subPath: db.sqlite3

        resources:
          requests:
            memory: "512Mi"
            cpu: "200m"
          limits:
            memory: "1Gi"
            cpu: "1000m"

      volumes:
      - name: db-storage
        persistentVolumeClaim:
          claimName: migraine-db-pvc

---
# Celery Beat - Scheduler (MUST be singleton)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: migraine-forecast-celery-beat
  namespace: migraine-forecast
  labels:
    app: migraine-forecast
    component: celery-beat
spec:
  # MUST be 1 - only one beat scheduler
  replicas: 1

  # Recreate strategy to ensure only one beat at a time
  strategy:
    type: Recreate

  selector:
    matchLabels:
      app: migraine-forecast
      component: celery-beat

  template:
    metadata:
      labels:
        app: migraine-forecast
        component: celery-beat
    spec:
      containers:
      - name: celery-beat
        image: alexandrosm77/migraine_forecast:latest
        imagePullPolicy: Always

        command: ["/bin/bash", "-c"]
        args:
          - |
            echo "Starting Celery Beat scheduler..."
            exec celery -A migraine_project beat \
              --loglevel=info

        envFrom:
        - configMapRef:
            name: migraine-config

        env:
        - name: SENTRY_DSN
          valueFrom:
            secretKeyRef:
              name: migraine-secrets
              key: SENTRY_DSN
        - name: CELERY_BROKER_URL
          valueFrom:
            secretKeyRef:
              name: migraine-secrets
              key: CELERY_BROKER_URL
        - name: CELERY_RESULT_BACKEND
          valueFrom:
            secretKeyRef:
              name: migraine-secrets
              key: CELERY_RESULT_BACKEND
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: migraine-secrets
              key: DB_PASSWORD

        volumeMounts:
        - name: db-storage
          mountPath: /app/db.sqlite3
          subPath: db.sqlite3

        resources:
          requests:
            memory: "128Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
            cpu: "200m"

      volumes:
      - name: db-storage
        persistentVolumeClaim:
          claimName: migraine-db-pvc

