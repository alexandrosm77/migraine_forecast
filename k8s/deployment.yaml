# Web Deployment - Runs Gunicorn web server (can scale)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: migraine-forecast-web
  namespace: migraine-forecast
  labels:
    app: migraine-forecast
    component: web
spec:
  # Can scale this up if needed
  replicas: 1

  # Deployment strategy - RollingUpdate for zero-downtime deployments
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1

  selector:
    matchLabels:
      app: migraine-forecast
      component: web

  template:
    metadata:
      labels:
        app: migraine-forecast
        component: web
    spec:
      containers:
      - name: web
        image: alexandrosm77/migraine_forecast:latest
        imagePullPolicy: Always

        # Override CMD to run only gunicorn (no cron)
        command: ["/bin/bash", "-c"]
        args:
          - |
            echo "Starting gunicorn web server..."
            exec gunicorn migraine_project.wsgi:application -c gunicorn.conf.py

        ports:
        - containerPort: 8889
          name: http
          protocol: TCP

        # Environment variables from ConfigMap
        envFrom:
        - configMapRef:
            name: migraine-config

        # Environment variables from Secret
        env:
        - name: SENTRY_DSN
          valueFrom:
            secretKeyRef:
              name: migraine-secrets
              key: SENTRY_DSN

        # Volume mounts - read-only for web (SQLite allows multiple readers)
        volumeMounts:
        - name: db-storage
          mountPath: /app/db.sqlite3
          subPath: db.sqlite3
          readOnly: true  # Web only reads, cron pod writes

        # Health checks
        livenessProbe:
          httpGet:
            path: /
            port: 8889
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

        readinessProbe:
          httpGet:
            path: /
            port: 8889
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3

        # Resource limits
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "1Gi"
            cpu: "1000m"

      volumes:
      - name: db-storage
        persistentVolumeClaim:
          claimName: migraine-db-pvc

---
# Cron Deployment - Runs scheduled tasks (single replica, no scaling)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: migraine-forecast-cron
  namespace: migraine-forecast
  labels:
    app: migraine-forecast
    component: cron
spec:
  # MUST be 1 - cron jobs should not run in parallel
  replicas: 1

  # Deployment strategy - Recreate to ensure only one cron pod at a time
  strategy:
    type: Recreate

  selector:
    matchLabels:
      app: migraine-forecast
      component: cron

  template:
    metadata:
      labels:
        app: migraine-forecast
        component: cron
    spec:
      containers:
      - name: cron
        image: alexandrosm77/migraine_forecast:latest
        imagePullPolicy: Always

        # Override CMD to run only cron (no gunicorn)
        command: ["/bin/bash", "-c"]
        args:
          - |
            echo "Starting cron daemon..."
            cron
            echo "Cron started. Tailing logs..."
            tail -f /var/log/cron.log

        # Environment variables from ConfigMap
        envFrom:
        - configMapRef:
            name: migraine-config

        # Environment variables from Secret
        env:
        - name: SENTRY_DSN
          valueFrom:
            secretKeyRef:
              name: migraine-secrets
              key: SENTRY_DSN

        # Volume mounts - read-write for cron (writes to database)
        volumeMounts:
        - name: db-storage
          mountPath: /app/db.sqlite3
          subPath: db.sqlite3
          # No readOnly - cron needs to write

        # Resource limits - higher for LLM inference
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "1Gi"
            cpu: "1000m"

      volumes:
      - name: db-storage
        persistentVolumeClaim:
          claimName: migraine-db-pvc

