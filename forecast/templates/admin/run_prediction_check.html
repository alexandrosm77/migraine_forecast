{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Run Prediction Check{% endblock %}

{% block content %}
<div style="max-width: 900px; margin: 0 auto; padding: 20px;">
    <h1 style="color: #333; margin-bottom: 10px;">üîÆ Run Prediction Check</h1>
    <p style="color: #666; margin-bottom: 30px;">Manually trigger the prediction pipeline or send test notifications</p>

    <form method="get" action="{% url 'admin:execute_prediction_check' %}" id="prediction-form" style="background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <!-- Mode Selection -->
        <div style="margin-bottom: 25px;">
            <h3 style="margin: 0 0 15px 0; color: #1a1a1a; font-size: 18px; font-weight: 600;">Mode Selection</h3>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <!-- Normal Mode Card -->
                <div class="mode-card" onclick="selectMode('normal')" id="normal-card" style="border: 3px solid #0066cc; background-color: #ffffff; padding: 15px; border-radius: 6px; cursor: pointer;">
                    <input type="radio" name="mode" value="normal" id="mode-normal" checked style="margin-right: 8px;">
                    <label for="mode-normal" style="cursor: pointer; font-weight: bold; color: #0066cc; font-size: 16px;">
                        üîÑ Normal Mode
                    </label>
                    <p style="margin: 8px 0 0 0; font-size: 14px; color: #1a1a1a; line-height: 1.5;">
                        Run full pipeline: collect weather, generate predictions, send notifications
                    </p>
                </div>

                <!-- Test Mode Card -->
                <div class="mode-card" onclick="selectMode('test')" id="test-card" style="border: 2px solid #ddd; background-color: #ffffff; padding: 15px; border-radius: 6px; cursor: pointer;">
                    <input type="radio" name="mode" value="test" id="mode-test" style="margin-right: 8px;">
                    <label for="mode-test" style="cursor: pointer; font-weight: bold; color: #cc6600; font-size: 16px;">
                        üß™ Test Mode
                    </label>
                    <p style="margin: 8px 0 0 0; font-size: 14px; color: #1a1a1a; line-height: 1.5;">
                        Send test notifications with fake predictions (for testing)
                    </p>
                </div>
            </div>
        </div>

        <!-- Normal Mode Options -->
        <div id="normal-options" style="margin-bottom: 25px;">
            <!-- Hidden field to always run in async mode -->
            <input type="hidden" name="async" value="on">

            <h3 style="margin: 0 0 15px 0; color: #1a1a1a; font-size: 18px; font-weight: 600;">Pipeline Steps</h3>

            <div style="background-color: #f5f5f5; padding: 18px; border-radius: 6px; border: 1px solid #ddd; margin-bottom: 15px;">
                <label style="display: flex; align-items: flex-start; cursor: pointer;">
                    <input type="checkbox" name="update_weather" id="update-weather-check" style="margin-right: 10px; margin-top: 3px; width: 18px; height: 18px;" checked>
                    <div>
                        <strong style="color: #1a1a1a; font-size: 15px;">Update Weather Data</strong>
                        <p style="margin: 5px 0 0 0; font-size: 14px; color: #1a1a1a; line-height: 1.5;">
                            Collect latest weather forecasts from API (Task 1)
                        </p>
                    </div>
                </label>
            </div>

            <div style="background-color: #f5f5f5; padding: 18px; border-radius: 6px; border: 1px solid #ddd; margin-bottom: 15px;">
                <label style="display: flex; align-items: flex-start; cursor: pointer;">
                    <input type="checkbox" name="get_predictions" id="get-predictions-check" style="margin-right: 10px; margin-top: 3px; width: 18px; height: 18px;" checked>
                    <div>
                        <strong style="color: #1a1a1a; font-size: 15px;">Get LLM Predictions</strong>
                        <p style="margin: 5px 0 0 0; font-size: 14px; color: #1a1a1a; line-height: 1.5;">
                            Generate migraine/sinusitis predictions using LLM (Task 2 - slow)
                        </p>
                    </div>
                </label>
            </div>

            <div style="background-color: #f5f5f5; padding: 18px; border-radius: 6px; border: 1px solid #ddd;">
                <label style="display: flex; align-items: flex-start; cursor: pointer;">
                    <input type="checkbox" name="send_notifications" id="send-notifications-check" style="margin-right: 10px; margin-top: 3px; width: 18px; height: 18px;">
                    <div>
                        <strong style="color: #1a1a1a; font-size: 15px;">Send Notifications</strong>
                        <p style="margin: 5px 0 0 0; font-size: 14px; color: #1a1a1a; line-height: 1.5;">
                            Process and send email notifications to users (Task 3)
                        </p>
                    </div>
                </label>
            </div>
        </div>

        <!-- Test Mode Options -->
        <div id="test-options" style="margin-bottom: 25px; display: none;">
            <h3 style="margin: 0 0 15px 0; color: #1a1a1a; font-size: 18px; font-weight: 600;">Test Configuration</h3>

            <div style="background-color: #fff8e6; padding: 15px; border-radius: 6px; border-left: 4px solid #cc6600; margin-bottom: 15px;">
                <strong style="color: #1a1a1a;">‚ö†Ô∏è Warning:</strong> <span style="color: #1a1a1a;">Test mode will send actual emails to all configured users.</span>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #1a1a1a; font-size: 15px;">Risk Level:</label>
                <select name="test_notification" id="test-notification" style="width: 100%; padding: 10px; border: 2px solid #999; border-radius: 4px; font-size: 15px; color: #1a1a1a; background-color: white;" disabled>
                    <option value="">-- Select Risk Level --</option>
                    <option value="high">High Risk</option>
                    <option value="medium">Medium Risk</option>
                    <option value="low">Low Risk</option>
                    <option value="none">None (No notification)</option>
                </select>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #1a1a1a; font-size: 15px;">Prediction Type:</label>
                <select name="test_type" id="test-type" style="width: 100%; padding: 10px; border: 2px solid #999; border-radius: 4px; font-size: 15px; color: #1a1a1a; background-color: white;" disabled>
                    <option value="both">Both (Migraine + Sinusitis)</option>
                    <option value="migraine">Migraine Only</option>
                    <option value="sinusitis">Sinusitis Only</option>
                </select>
            </div>
        </div>

        <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef;">
            <button type="submit" style="background-color: #0066cc; color: white; padding: 14px 35px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; font-weight: bold;">
                ‚ñ∂ Run Prediction Check
            </button>
            <a href="{% url 'admin:view_prediction_logs' %}" style="margin-left: 15px; padding: 14px 35px; background-color: #666; color: white; text-decoration: none; border-radius: 6px; display: inline-block; font-weight: bold;">
                üìã View Logs
            </a>
            <a href="{% url 'admin:index' %}" style="margin-left: 15px; padding: 14px 35px; background-color: #999; color: white; text-decoration: none; border-radius: 6px; display: inline-block;">
                ‚Üê Back
            </a>
        </div>
    </form>
</div>

<style>
    .mode-card {
        transition: all 0.2s ease;
    }
    .mode-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    button[type="submit"]:hover {
        background-color: #0052a3 !important;
    }
    select:focus, input[type="checkbox"]:focus {
        outline: 2px solid #0066cc;
        outline-offset: 2px;
    }
</style>

<script>
    function selectMode(mode) {
        const normalCard = document.getElementById('normal-card');
        const testCard = document.getElementById('test-card');
        const normalOptions = document.getElementById('normal-options');
        const testOptions = document.getElementById('test-options');
        const testNotificationSelect = document.getElementById('test-notification');

        if (mode === 'normal') {
            // Update radio buttons
            document.getElementById('mode-normal').checked = true;
            document.getElementById('mode-test').checked = false;

            // Update card styles
            normalCard.style.border = '3px solid #0066cc';
            normalCard.style.backgroundColor = '#ffffff';
            testCard.style.border = '2px solid #ddd';
            testCard.style.backgroundColor = '#ffffff';

            // Show/hide options
            normalOptions.style.display = 'block';
            testOptions.style.display = 'none';

            // Clear test notification value so it doesn't get submitted
            testNotificationSelect.value = '';
            testNotificationSelect.disabled = true;
            document.getElementById('test-type').disabled = true;
        } else {
            // Update radio buttons
            document.getElementById('mode-normal').checked = false;
            document.getElementById('mode-test').checked = true;

            // Update card styles
            normalCard.style.border = '2px solid #ddd';
            normalCard.style.backgroundColor = '#ffffff';
            testCard.style.border = '3px solid #cc6600';
            testCard.style.backgroundColor = '#ffffff';

            // Show/hide options
            normalOptions.style.display = 'none';
            testOptions.style.display = 'block';

            // Enable test fields and set default value
            testNotificationSelect.disabled = false;
            testNotificationSelect.value = 'high';
            document.getElementById('test-type').disabled = false;
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        selectMode('normal');
    });

    // Handle form submission - remove disabled fields from submission
    document.getElementById('prediction-form').addEventListener('submit', function(e) {
        const mode = document.querySelector('input[name="mode"]:checked').value;

        if (mode === 'normal') {
            // Remove test_notification from the form by clearing its name attribute
            const testNotification = document.getElementById('test-notification');
            const testType = document.getElementById('test-type');
            testNotification.removeAttribute('name');
            testType.removeAttribute('name');
        } else {
            // In test mode, remove pipeline step checkboxes
            const updateWeather = document.getElementById('update-weather-check');
            const getPredictions = document.getElementById('get-predictions-check');
            const sendNotifications = document.getElementById('send-notifications-check');
            updateWeather.removeAttribute('name');
            getPredictions.removeAttribute('name');
            sendNotifications.removeAttribute('name');
        }
    });
</script>
{% endblock %}

